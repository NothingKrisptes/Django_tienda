{% extends 'tienda/base.html' %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid var(--secundario); padding-bottom: 20px;">
    <div>
        <h2 style="margin: 0; color: var(--secundario);">ğŸšš GestiÃ³n de EnvÃ­os (Bodega)</h2>
        <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">Administra el estado de los pedidos.</p>
    </div>
</div>

<!-- FILTROS Y CONTROLES -->
<div style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; gap: 15px; align-items: center;">
        <label for="filtroEstado" style="font-weight: bold;">Filtrar por Estado:</label>
        <select id="filtroEstado" onchange="filtrarPedidos()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">Todos</option>
            <option value="REVISION">En RevisiÃ³n</option>
            <option value="PREPARANDO">Preparando</option>
            <option value="EN_CAMINO">En Camino</option>
            <option value="ENTREGADO">Entregado</option>
        </select>
    </div>

    <!-- BOTÃ“N DESCARGAR PDF -->
    <a href="{% url 'reporte_bodega_pdf' %}" class="btn" style="background: #2ecc71; display: flex; align-items: center; gap: 8px; text-decoration: none; color: white; padding: 10px 20px; border-radius: 5px; font-weight: bold;">
        ğŸ“„ Descargar Reporte PDF
    </a>
</div>

<!-- LISTA DE PEDIDOS -->
<div id="listaPedidos">
    {% for orden in ordenes %}
    <div class="pedido-card" data-estado="{{ orden.estadoEntrega }}" style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid {% if orden.estadoEntrega == 'REVISION' %}#ff9800{% elif orden.estadoEntrega == 'PREPARANDO' %}#9c27b0{% elif orden.estadoEntrega == 'EN_CAMINO' %}#2196f3{% else %}#4caf50{% endif %}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        
        <!-- ENCABEZADO DEL PEDIDO -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
            <div>
                <h3 style="margin: 0; font-size: 1.2rem; color: var(--secundario);">Orden #{{ orden.id }}</h3>
                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">{{ orden.fechaCompra|date:'d/m/Y H:i' }}</p>
            </div>
            <div style="text-align: right;">
                <span style="display: inline-block; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; 
                    {% if orden.estadoEntrega == 'REVISION' %}background: #fff3e0; color: #ff9800;
                    {% elif orden.estadoEntrega == 'PREPARANDO' %}background: #f3e5f5; color: #9c27b0;
                    {% elif orden.estadoEntrega == 'EN_CAMINO' %}background: #e3f2fd; color: #2196f3;
                    {% else %}background: #e8f5e9; color: #4caf50;{% endif %}">
                    {{ orden.get_estadoEntrega_display }}
                </span>
            </div>
        </div>

        <!-- DATOS DEL CLIENTE -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; padding: 15px; background: #f9f9f9; border-radius: 6px;">
            <div>
                <p style="margin: 0; font-weight: bold; color: #333;">ğŸ‘¤ Cliente:</p>
                <p style="margin: 5px 0 0 0; font-size: 0.95rem; color: #666;">
                    {% if orden.cliente.first_name %}
                        {{ orden.cliente.first_name }} {{ orden.cliente.last_name }}
                    {% else %}
                        {{ orden.cliente.username }}
                    {% endif %}
                </p>
                <p style="margin: 3px 0 0 0; font-size: 0.85rem; color: #999;">
                    ğŸ“§ {{ orden.cliente.email }}
                </p>
            </div>
            
            <div>
                <p style="margin: 0; font-weight: bold; color: #333;">ğŸ“ Entrega:</p>
                <p style="margin: 5px 0 0 0; font-size: 0.95rem; color: #666;">
                    {% if orden.tipoEntrega == 'DOMICILIO' %}
                        <strong>ğŸ  A Domicilio:</strong><br>{{ orden.direccionEntrega }}
                    {% else %}
                        <strong>ğŸª Retiro en Tienda</strong><br>Calle Principal 123, Quito
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- PRODUCTOS -->
        <div style="margin-bottom: 15px;">
            <p style="margin: 0 0 10px 0; font-weight: bold; color: #333;">ğŸ“¦ Productos:</p>
            <ul style="margin: 0; padding-left: 20px;">
                {% for detalle in orden.detalles.all %}
                <li style="margin: 5px 0; color: #666; font-size: 0.9rem;">
                    {{ detalle.cantidad }}x <strong>{{ detalle.producto.tituloDisco }}</strong> - ${{ detalle.precioUnitarioHistorico }}
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- ACTUALIZAR ESTADO CON VALIDACIÃ“N -->
        <div style="display: flex; gap: 10px; align-items: center;">
            <label style="font-weight: bold; color: #333;">Cambiar Estado:</label>
            <form method="POST" action="{% url 'actualizar_envio' orden.id %}" style="display: flex; gap: 10px;">
                {% csrf_token %}
                <select name="nuevoEstado" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: #fff;">
                    {% if orden.estadoEntrega == 'REVISION' %}
                        <option value="REVISION" selected>â³ En RevisiÃ³n</option>
                        <option value="PREPARANDO">ğŸ“¦ Preparando</option>
                        <option value="EN_CAMINO">ğŸšš En Camino</option>
                        <option value="ENTREGADO">âœ… Entregado</option>
                    {% elif orden.estadoEntrega == 'PREPARANDO' %}
                        <option value="REVISION" disabled style="color: #ccc;">â³ En RevisiÃ³n (Ya pasado)</option>
                        <option value="PREPARANDO" selected>ğŸ“¦ Preparando</option>
                        <option value="EN_CAMINO">ğŸšš En Camino</option>
                        <option value="ENTREGADO">âœ… Entregado</option>
                    {% elif orden.estadoEntrega == 'EN_CAMINO' %}
                        <option value="REVISION" disabled style="color: #ccc;">â³ En RevisiÃ³n (Ya pasado)</option>
                        <option value="PREPARANDO" disabled style="color: #ccc;">ğŸ“¦ Preparando (Ya pasado)</option>
                        <option value="EN_CAMINO" selected>ğŸšš En Camino</option>
                        <option value="ENTREGADO">âœ… Entregado</option>
                    {% elif orden.estadoEntrega == 'ENTREGADO' %}
                        <option value="REVISION" disabled style="color: #ccc;">â³ En RevisiÃ³n (Ya pasado)</option>
                        <option value="PREPARANDO" disabled style="color: #ccc;">ğŸ“¦ Preparando (Ya pasado)</option>
                        <option value="EN_CAMINO" disabled style="color: #ccc;">ğŸšš En Camino (Ya pasado)</option>
                        <option value="ENTREGADO" selected>âœ… Entregado</option>
                    {% endif %}
                </select>
                <button type="submit" class="btn" style="background: var(--secundario); color: white; padding: 8px 16px; font-size: 0.9rem; border: none; border-radius: 4px; cursor: pointer;">
                    âœ“ Actualizar
                </button>
            </form>
        </div>

    </div>
    {% empty %}
    <div style="text-align: center; padding: 40px; background: #fff; border-radius: 8px; color: #999;">
        <p style="font-size: 1.2rem; margin: 0;">No hay pedidos pendientes.</p>
    </div>
    {% endfor %}
</div>

<script>
function filtrarPedidos() {
    const filtro = document.getElementById('filtroEstado').value;
    const pedidos = document.querySelectorAll('.pedido-card');
    
    pedidos.forEach(pedido => {
        if (filtro === '' || pedido.dataset.estado === filtro) {
            pedido.style.display = 'block';
        } else {
            pedido.style.display = 'none';
        }
    });
}
</script>

{% endblock %}
